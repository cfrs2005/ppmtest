# 项目记忆档案

本文件记录项目开发过程中的重要决策、技术选型、问题解决方案和学习要点。

## 项目概述

**项目名称**: Go 博客系统 (类似 WordPress)
**技术栈**: Go 1.21+, MySQL, GLM AI, Gin, GORM
**核心目标**: 构建一个功能完整的博客系统，同时作为 Go 语言学习的实战项目

## 项目历史

### 2025-12-30: 项目进度整理和文档更新

#### 重大决策
1. **完成教学文档体系**
   - 完成 Lesson 01-09 所有章节
   - 涵盖从数据库设计到并发编程的完整知识体系
   - 提供实战案例和最佳实践

2. **三层架构实现完成**
   - 数据库层：Repository 模式、GORM 集成
   - 服务层：依赖注入、业务逻辑封装
   - API 层：Gin 框架、中间件体系

3. **核心功能基础完成**
   - JWT 认证系统
   - 用户和文章模型
   - 基础 CRUD 操作
   - 中间件（日志、CORS、恢复）

#### 已完成的阶段

**第一阶段：数据库层 (Data Layer)** ✅
- 数据库连接池设计
- GORM 配置和最佳实践
- 数据库迁移脚本
- Repository 模式实现
- 数据模型验证和钩子
- **Lesson 01**: Go 数据库设计基础

**第二阶段：业务逻辑层 (Service Layer)** ✅
- 服务接口设计
- 依赖注入模式
- 业务逻辑实现
- 错误处理策略
- 事务管理
- **Lesson 02**: Go 服务层架构设计

**第三阶段：HTTP API 层 (Presentation Layer)** ✅
- Gin 路由配置
- 中间件实现（认证、日志、CORS、恢复）
- 请求验证
- 响应格式标准化
- 错误处理中间件
- 优雅关闭实现
- **Lesson 03**: Web 框架最佳实践
- **Lesson 04**: 中间件模式
- **Lesson 05**: 错误处理策略

**第四阶段：测试和优化** ✅
- 测试最佳实践
- 性能优化技巧
- 安全实践
- 并发编程模式
- **Lesson 06**: 测试最佳实践
- **Lesson 07**: 性能优化技巧
- **Lesson 08**: 安全实践
- **Lesson 09**: 并发编程模式

### 2025-12-28: 项目重构和文档系统建立

#### 重大决策
1. **项目定位调整**
   - 主要目标：构建完整的 Go 博客系统
   - 核心价值：作为 Go 语言学习项目，从入门到精通
   - 重点：架构设计、技巧实践、性能优化、数据库设计
   - 文档化：所有经验教训记录在 `/docs/lessons/` 系列

2. **代码清理**
   - 删除 107 个文件，减少 24,531 行旧代码
   - 清理所有 Python 代码和测试
   - 删除旧文档和静态资源
   - 建立标准的 Go 项目结构

3. **基础架构建立**
   - 创建 `go.mod` 和 `go.sum`
   - 建立标准目录结构 (`cmd/`, `internal/`, `pkg/`)
   - 添加 Makefile 构建工具
   - 配置环境变量管理 (`.env.example`)

4. **数据模型设计**
   - `internal/models/post.go` - 文章模型
   - `internal/models/user.go` - 用户模型
   - 支持评论、标签、分类模型

#### 已完成的阶段

**第一阶段：数据库层 (Data Layer)** ✅
- 数据库连接池设计
- GORM 配置和最佳实践
- 数据库迁移脚本
- Repository 模式实现
- 数据模型验证和钩子
- **Lesson 01**: Go 数据库设计基础

**第二阶段：业务逻辑层 (Service Layer)** ✅
- 服务接口设计
- 依赖注入模式
- 业务逻辑实现
- 错误处理策略
- 事务管理
- **Lesson 02**: Go 服务层架构设计

**第三阶段：HTTP API 层 (Presentation Layer)** ✅
- Gin 路由配置
- 中间件实现（认证、日志、CORS、恢复）
- 请求验证
- 响应格式标准化
- 错误处理中间件
- 优雅关闭实现

#### 关键技术决策

1. **架构模式**
   - 分层架构：Data Layer → Service Layer → Presentation Layer
   - Repository 模式：数据访问抽象
   - 依赖注入：使用容器模式管理依赖
   - 接口优先：定义清晰的接口契约

2. **数据库设计**
   - 使用 GORM 作为 ORM
   - 连接池管理（最大连接数、空闲连接数）
   - 自动迁移和版本控制
   - 软删除支持
   - 时间戳自动管理

3. **错误处理**
   - 自定义错误类型
   - 错误包装和上下文
   - 统一的错误响应格式
   - 日志记录和追踪

4. **中间件策略**
   - 认证中间件（JWT）
   - 日志中间件（请求追踪）
   - CORS 中间件（跨域支持）
   - 恢复中间件（panic 处理）
   - 请求 ID 生成

5. **测试策略**
   - 表驱动测试
   - 真实数据库集成测试
   - Mock 外部依赖
   - 测试覆盖率目标

## 技术选型记录

### Web 框架
- **选择**: Gin
- **理由**:
  - 高性能路由
  - 中间件生态丰富
  - JSON 验证和绑定
  - 社区活跃，文档完善

### ORM
- **选择**: GORM
- **理由**:
  - 功能强大，易用性好
  - 支持自动迁移
  - 钩子机制完善
  - 关联关系处理简单

### 配置管理
- **选择**: Viper
- **理由**:
  - 支持多种配置格式
  - 环境变量支持
  - 热重载配置
  - 配置分层和覆盖

## 问题和解决方案

### 问题 1: 数据库连接池配置
**问题**: 如何合理配置数据库连接池参数？
**解决方案**:
- `SetMaxOpenConns(25)`: 最大打开连接数
- `SetMaxIdleConns(25)`: 最大空闲连接数
- `SetConnMaxLifetime(5 * time.Minute)`: 连接最大生命周期
- 参考：`internal/database/database.go:32-35`

### 问题 2: 依赖注入实现
**问题**: 如何优雅地管理项目依赖？
**解决方案**:
- 创建容器统一管理所有依赖
- 使用接口定义依赖契约
- 延迟初始化（lazy initialization）
- 参考：`internal/container/container.go`

### 问题 3: 错误处理标准化
**问题**: 如何统一处理各种错误？
**解决方案**:
- 定义业务错误类型
- 错误码规范
- 错误包装和上下文传递
- 统一的 HTTP 响应格式
- 参考：`internal/service/` 各服务文件

## 性能优化要点

### 数据库层
- 使用索引优化查询
- 避免 N+1 查询问题
- 合理使用预加载（Preload）
- 连接池参数调优

### 应用层
- 请求验证尽早进行
- 避免重复查询
- 使用缓存减少数据库访问
- 并发处理独立任务

### API 层
- 分页控制，避免大数据集返回
- 响应数据精简，只返回必要字段
- 压缩响应内容
- 使用 HTTP 缓存头

## 安全考虑

### 认证和授权
- JWT Token 认证
- 密码哈希存储（bcrypt）
- Token 过期机制
- 权限验证

### 数据安全
- SQL 注入防护（GORM 参数化查询）
- XSS 防护（输入验证和输出转义）
- CSRF 防护（Token 验证）
- 敏感数据加密

### API 安全
- 速率限制
- CORS 配置
- 请求大小限制
- 错误信息不泄露敏感数据

## 学习要点

### Go 语言特性
1. **接口**: 接口组合和隐式实现
2. **并发**: goroutine 和 channel 使用
3. **错误处理**: error 接口和错误包装
4. **上下文**: context.Context 的使用场景
5. **defer**: 资源清理和优雅关闭

### 设计模式
1. **Repository 模式**: 数据访问抽象
2. **依赖注入**: 控制反转
3. **工厂模式**: 对象创建
4. **策略模式**: 算法封装
5. **中间件模式**: 请求处理链

### 最佳实践
1. **代码组织**: 遵循 Go 项目布局标准
2. **命名规范**: 驼峰命名，缩写全大写
3. **注释规范**: 导出的函数必须有注释
4. **错误处理**: 不要忽略错误
5. **测试**: 表驱动测试，覆盖边界情况

## 未来规划

### 短期目标（2025-01 月）
- [ ] 实现完整的评论系统（嵌套评论）
- [ ] 实现标签和分类管理
- [ ] 实现用户权限和角色管理
- [ ] 实现文章搜索功能
- [ ] 编写完整的单元测试和集成测试

### 中期目标（2025-02 月）
- [ ] 设计并实现 GLM AI 服务架构
- [ ] 实现 AI 内容生成接口
- [ ] 实现智能摘要功能
- [ ] 实现自动标签推荐
- [ ] 实现垃圾评论检测
- [ ] 缓存层实现（Redis）

### 长期目标（2025-03 月及以后）
- [ ] 性能优化和压力测试
- [ ] Docker 容器化
- [ ] CI/CD 流水线配置
- [ ] 生产环境部署
- [ ] 监控和日志系统
- [ ] 微服务架构改造（可选）

## 重要链接

- **仓库**: https://github.com/cfrs2005/ppmtest
- **主分支**: main
- **文档**: `/docs/lessons/`
- **API 定义**: `/api/`

## 更新日志

### 2025-12-30
- 整理和更新项目进度文档
- 更新 todo.md，标记已完成的教学章节（Lesson 01-09）
- 更新 memory.md，添加最新项目进度
- 制定详细的下一阶段开发计划
- 确认三层架构和核心功能已完成

### 2025-12-28
- 创建 memory.md 文件
- 创建 todo.md 文件
- 更新 CLAUDE.md 添加文档系统说明
- 建立项目知识管理体系