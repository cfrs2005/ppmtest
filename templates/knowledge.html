{% extends "base.html" %}

{% block title %}知识库 - Bilibili视频分析系统{% endblock %}

{% block content %}
<div class="container">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>
                    <i class="fas fa-book"></i> 知识库
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="exportKnowledge()">
                        <i class="fas fa-download"></i> 导出知识库
                    </button>
                    <button class="btn btn-success" onclick="showAddEntryModal()">
                        <i class="fas fa-plus"></i> 添加条目
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="search-form" class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="search-input" 
                                       placeholder="搜索知识条目..." value="{{ search }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="knowledge-type-filter">
                                <option value="">所有类型</option>
                                <option value="concept" {% if knowledge_type == 'concept' %}selected{% endif %}>概念</option>
                                <option value="definition" {% if knowledge_type == 'definition' %}selected{% endif %}>定义</option>
                                <option value="example" {% if knowledge_type == 'example' %}selected{% endif %}>示例</option>
                                <option value="technique" {% if knowledge_type == 'technique' %}selected{% endif %}>技巧</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-book fa-2x text-primary"></i>
                    <h5 class="mt-2">{{ entries.total }}</h5>
                    <p class="text-muted">总条目数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-tags fa-2x text-success"></i>
                    <h5 class="mt-2">{{ tags|length }}</h5>
                    <p class="text-muted">标签数量</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-star fa-2x text-warning"></i>
                    <h5 class="mt-2" id="avg-importance">4.2</h5>
                    <p class="text-muted">平均重要性</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-info"></i>
                    <h5 class="mt-2" id="recent-count">0</h5>
                    <p class="text-muted">最近7天</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Cloud Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud"></i> 标签云
                    </h5>
                </div>
                <div class="card-body">
                    <div id="tag-cloud">
                        {% for tag in tags %}
                        <span class="badge bg-secondary me-2 mb-2 tag-badge" 
                              data-tag="{{ tag.name }}" onclick="filterByTag('{{ tag.name }}')">
                            {{ tag.name }}
                            <span class="badge bg-light text-dark ms-1">{{ tag.knowledge_entries|length }}</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Entries Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">知识条目</h5>
                    <div>
                        <select class="form-select form-select-sm" id="sort-select" style="width: auto;">
                            <option value="importance-desc">重要性降序</option>
                            <option value="importance-asc">重要性升序</option>
                            <option value="created-desc">创建时间降序</option>
                            <option value="created-asc">创建时间升序</option>
                            <option value="updated-desc">更新时间降序</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="knowledge-entries">
                        {% for entry in entries.items %}
                        <div class="card mb-3 knowledge-entry" data-entry-id="{{ entry.id }}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="card-title">
                                            <span class="badge bg-{{ get_importance_color(entry.importance) }} me-2">
                                                {{ entry.importance }}
                                            </span>
                                            {{ entry.title }}
                                        </h5>
                                        <p class="card-text">
                                            {{ entry.content[:300] }}
                                            {% if entry.content|length > 300 %}
                                            <a href="#" onclick="showEntryDetail({{ entry.id }})">查看更多</a>
                                            {% endif %}
                                        </p>
                                        <div class="mb-2">
                                            {% for tag in entry.tags %}
                                            <span class="badge bg-primary me-1">{{ tag.name }}</span>
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">
                                            类型: {{ get_knowledge_type_label(entry.knowledge_type) }} | 
                                            创建时间: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group-vertical" role="group">
                                            <a href="/knowledge/{{ entry.id }}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i> 查看详情
                                            </a>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="editEntry({{ entry.id }})">
                                                <i class="fas fa-edit"></i> 编辑
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteEntry({{ entry.id }})">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if entries.items|length == 0 %}
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted"></i>
                            <p class="text-muted mt-3">没有找到匹配的知识条目</p>
                            <button class="btn btn-primary" onclick="showAddEntryModal()">
                                <i class="fas fa-plus"></i> 添加第一个条目
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if entries.pages > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if entries.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.knowledge', page=entries.prev_num, search=search, knowledge_type=knowledge_type) }}">
                                    上一页
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in entries.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != entries.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.knowledge', page=page_num, search=search, knowledge_type=knowledge_type) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if entries.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.knowledge', page=entries.next_num, search=search, knowledge_type=knowledge_type) }}">
                                    下一页
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Entry Modal -->
<div class="modal fade" id="entry-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="entry-modal-title">添加知识条目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="entry-form">
                    <input type="hidden" id="entry-id">
                    <div class="mb-3">
                        <label for="entry-title" class="form-label">标题</label>
                        <input type="text" class="form-control" id="entry-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="entry-content" class="form-label">内容</label>
                        <textarea class="form-control" id="entry-content" rows="5" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="entry-type" class="form-label">类型</label>
                            <select class="form-select" id="entry-type">
                                <option value="concept">概念</option>
                                <option value="definition">定义</option>
                                <option value="example">示例</option>
                                <option value="technique">技巧</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="entry-importance" class="form-label">重要性</label>
                            <select class="form-select" id="entry-importance">
                                <option value="1">1 - 低</option>
                                <option value="2">2 - 中低</option>
                                <option value="3" selected>3 - 中等</option>
                                <option value="4">4 - 高</option>
                                <option value="5">5 - 非常高</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="entry-tags" class="form-label">标签</label>
                        <input type="text" class="form-control" id="entry-tags" 
                               placeholder="用逗号分隔多个标签">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEntry()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Entry Detail Modal -->
<div class="modal fade" id="entry-detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="entry-detail-title">知识条目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="entry-detail-content">
                <!-- Content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadKnowledgeStats();
    initializeEventListeners();
});

// 初始化事件监听器
function initializeEventListeners() {
    // 搜索表单提交
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // 排序选择器变化
    document.getElementById('sort-select').addEventListener('change', function() {
        performSearch();
    });
}

// 加载知识库统计
function loadKnowledgeStats() {
    fetch('/api/v1/knowledge/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.data;
                document.getElementById('avg-importance').textContent = stats.average_importance.toFixed(1);
                document.getElementById('recent-count').textContent = stats.recent_count;
            }
        })
        .catch(error => {
            console.error('Error loading knowledge stats:', error);
        });
}

// 执行搜索
function performSearch() {
    const search = document.getElementById('search-input').value;
    const knowledgeType = document.getElementById('knowledge-type-filter').value;
    const sort = document.getElementById('sort-select').value;
    
    // 构建URL参数
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (knowledgeType) params.append('knowledge_type', knowledgeType);
    if (sort) params.append('sort', sort);
    
    // 跳转到搜索结果页面
    window.location.href = '/knowledge?' + params.toString();
}

// 显示添加条目模态框
function showAddEntryModal() {
    document.getElementById('entry-modal-title').textContent = '添加知识条目';
    document.getElementById('entry-form').reset();
    document.getElementById('entry-id').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('entry-modal'));
    modal.show();
}

// 编辑条目
function editEntry(entryId) {
    document.getElementById('entry-modal-title').textContent = '编辑知识条目';
    document.getElementById('entry-id').value = entryId;
    
    // 获取条目数据
    fetch(`/api/v1/knowledge/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const entry = data.data;
                document.getElementById('entry-title').value = entry.title;
                document.getElementById('entry-content').value = entry.content;
                document.getElementById('entry-type').value = entry.knowledge_type;
                document.getElementById('entry-importance').value = entry.importance;
                document.getElementById('entry-tags').value = entry.tags.join(', ');
                
                const modal = new bootstrap.Modal(document.getElementById('entry-modal'));
                modal.show();
            } else {
                showToast('错误', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading entry:', error);
            showToast('错误', '加载条目失败', 'error');
        });
}

// 保存条目
function saveEntry() {
    const entryId = document.getElementById('entry-id').value;
    const title = document.getElementById('entry-title').value;
    const content = document.getElementById('entry-content').value;
    const knowledgeType = document.getElementById('entry-type').value;
    const importance = document.getElementById('entry-importance').value;
    const tags = document.getElementById('entry-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
    
    const data = {
        title: title,
        content: content,
        knowledge_type: knowledgeType,
        importance: parseInt(importance),
        tags: tags
    };
    
    const url = entryId ? `/api/v1/knowledge/${entryId}` : '/api/v1/knowledge';
    const method = entryId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', entryId ? '条目更新成功' : '条目创建成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('entry-modal')).hide();
            // 刷新页面
            window.location.reload();
        } else {
            showToast('错误', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving entry:', error);
        showToast('错误', '保存条目失败', 'error');
    });
}

// 删除条目
function deleteEntry(entryId) {
    if (!confirm('确定要删除这个知识条目吗？')) {
        return;
    }
    
    fetch(`/api/v1/knowledge/${entryId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '条目删除成功', 'success');
            // 移除条目元素
            const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryElement) {
                entryElement.remove();
            }
        } else {
            showToast('错误', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting entry:', error);
        showToast('错误', '删除条目失败', 'error');
    });
}

// 显示条目详情
function showEntryDetail(entryId) {
    fetch(`/api/v1/knowledge/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const entry = data.data;
                const content = `
                    <div class="row">
                        <div class="col-md-8">
                            <h4>${entry.title}</h4>
                            <div class="mb-3">
                                <span class="badge bg-{{ get_importance_color(entry.importance) }} me-2">
                                    重要性: ${entry.importance}
                                </span>
                                <span class="badge bg-secondary me-2">
                                    ${get_knowledge_type_label(entry.knowledge_type)}
                                </span>
                            </div>
                            <div class="mb-3">
                                ${entry.tags.map(tag => `<span class="badge bg-primary me-1">${tag}</span>`).join('')}
                            </div>
                            <div class="content-text">
                                ${entry.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">条目信息</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>创建时间:</strong> ${new Date(entry.created_at).toLocaleString()}</p>
                                    <p><strong>更新时间:</strong> ${new Date(entry.updated_at).toLocaleString()}</p>
                                    ${entry.analysis ? `
                                    <p><strong>来源视频:</strong> ${entry.analysis.video?.title || '未知'}</p>
                                    <p><strong>分析时间:</strong> ${new Date(entry.analysis.created_at).toLocaleString()}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('entry-detail-content').innerHTML = content;
                document.getElementById('entry-detail-title').textContent = entry.title;
                
                const modal = new bootstrap.Modal(document.getElementById('entry-detail-modal'));
                modal.show();
            } else {
                showToast('错误', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading entry detail:', error);
            showToast('错误', '加载条目详情失败', 'error');
        });
}

// 按标签过滤
function filterByTag(tagName) {
    document.getElementById('search-input').value = tagName;
    performSearch();
}

// 导出知识库
function exportKnowledge() {
    const format = prompt('选择导出格式 (json, markdown, csv):', 'json');
    if (format && ['json', 'markdown', 'csv'].includes(format)) {
        window.open(`/api/v1/knowledge/export?format=${format}`, '_blank');
    }
}

// 获取重要性颜色
function get_importance_color(importance) {
    const colors = {
        1: 'secondary',
        2: 'info',
        3: 'primary',
        4: 'warning',
        5: 'danger'
    };
    return colors[importance] || 'secondary';
}

// 获取知识类型标签
function get_knowledge_type_label(type) {
    const labels = {
        'concept': '概念',
        'definition': '定义',
        'example': '示例',
        'technique': '技巧'
    };
    return labels[type] || type;
}
</script>
{% endblock %}