{% extends "base.html" %}

{% block title %}分析结果 - Bilibili视频分析系统{% endblock %}

{% block content %}
<div class="container">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="fas fa-chart-line"></i> 分析结果
                    </h1>
                    <p class="text-muted">视频ID: {{ analysis.video.bvid }}</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="exportAnalysis()">
                        <i class="fas fa-download"></i> 导出结果
                    </button>
                    <button class="btn btn-outline-secondary" onclick="reanalyze()">
                        <i class="fas fa-redo"></i> 重新分析
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-video"></i> 视频信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h4>{{ analysis.video.title }}</h4>
                            <p class="text-muted">
                                <i class="fas fa-user"></i> {{ analysis.video.author }} | 
                                <i class="fas fa-calendar"></i> {{ analysis.video.published_at.strftime('%Y-%m-%d') if analysis.video.published_at else '未知' }}
                            </p>
                            <p class="text-muted">
                                <i class="fas fa-eye"></i> {{ analysis.video.view_count or 0 }} 次观看 | 
                                <i class="fas fa-thumbs-up"></i> {{ analysis.video.like_count or 0 }} 个点赞
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <img src="{{ analysis.video.cover_url or '/static/images/default-cover.jpg' }}" 
                                 alt="视频封面" class="img-fluid rounded" style="max-height: 120px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt"></i> 内容总结
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <div class="analysis-summary">
                                {{ analysis.summary | replace('\n', '<br>') | safe }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-brain fa-2x text-primary"></i>
                                    <h6>{{ analysis.model_used or 'Unknown' }}</h6>
                                    <small class="text-muted">分析模型</small>
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-clock fa-2x text-success"></i>
                                    <h6>{{ "%.2f"|format(analysis.analysis_time or 0) }}s</h6>
                                    <small class="text-muted">分析时间</small>
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-database fa-2x text-info"></i>
                                    <h6>{{ analysis.knowledge_entries.count() }}</h6>
                                    <small class="text-muted">知识点</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Points -->
    {% if analysis.key_points %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> 关键要点
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for point in analysis.key_points %}
                        <div class="col-md-6 mb-3">
                            <div class="key-point-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                {{ point }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Categories -->
    {% if analysis.categories %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tags"></i> 内容分类
                    </h5>
                </div>
                <div class="card-body">
                    <div class="categories-container">
                        {% for category in analysis.categories %}
                        <span class="badge bg-primary me-2 mb-2 category-badge">
                            <i class="fas fa-folder me-1"></i>
                            {{ category }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tags -->
    {% if analysis.tags %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-hashtag"></i> 标签
                    </h5>
                </div>
                <div class="card-body">
                    <div class="tags-container">
                        {% for tag in analysis.tags %}
                        <span class="badge bg-secondary me-2 mb-2 tag-badge">
                            {{ tag }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Knowledge Entries -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-book"></i> 知识条目 ({{ analysis.knowledge_entries.count() }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="knowledge-entries">
                        {% for entry in analysis.knowledge_entries %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card knowledge-entry-card h-100" data-entry-id="{{ entry.id }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title">{{ entry.title }}</h6>
                                        <span class="badge bg-{{ get_importance_color(entry.importance) }}">
                                            {{ entry.importance }}
                                        </span>
                                    </div>
                                    <p class="card-text">
                                        {{ entry.content[:150] }}
                                        {% if entry.content|length > 150 %}
                                        <a href="#" onclick="showEntryDetail({{ entry.id }})">查看更多</a>
                                        {% endif %}
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            {{ get_knowledge_type_label(entry.knowledge_type) }}
                                        </small>
                                        <div>
                                            {% for tag in entry.tags[:2] %}
                                            <span class="badge bg-primary me-1">{{ tag.name }}</span>
                                            {% endfor %}
                                            {% if entry.tags|length > 2 %}
                                            <span class="badge bg-outline-secondary">+{{ entry.tags|length - 2 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if analysis.knowledge_entries.count() == 0 %}
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-book-open fa-3x text-muted"></i>
                                <p class="text-muted mt-3">暂无知识条目</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> 分析统计
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-file-alt fa-2x text-primary"></i>
                                <h6>{{ analysis.total_tokens or 0 }}</h6>
                                <p class="text-muted">总Token数</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-dollar-sign fa-2x text-success"></i>
                                <h6>{{ "%.4f"|format(analysis.total_cost or 0) }}</h6>
                                <p class="text-muted">总成本($)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-layer-group fa-2x text-info"></i>
                                <h6>{{ analysis.chunk_count or 0 }}</h6>
                                <p class="text-muted">分块数量</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                                <h6>{{ "%.2f"|format(analysis.analysis_time or 0) }}s</h6>
                                <p class="text-muted">分析时间</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-link"></i> 相关分析
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="related-analysis">
                        <!-- Related analysis will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entry Detail Modal -->
<div class="modal fade" id="entry-detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="entry-detail-title">知识条目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="entry-detail-content">
                <!-- Content will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" class="btn btn-primary" id="view-entry-btn">
                    <i class="fas fa-external-link-alt"></i> 查看完整条目
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadRelatedAnalysis();
    initializeEventListeners();
});

// 初始化事件监听器
function initializeEventListeners() {
    // 监听分析完成事件
    App.Events.on('analysis:completed', function(data) {
        if (data.analysis_id === {{ analysis.id }}) {
            showToast('分析完成', '视频分析已成功完成', 'success');
            location.reload();
        }
    });
}

// 加载相关分析
function loadRelatedAnalysis() {
    fetch('/api/v1/analysis/related/{{ analysis.id }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRelatedAnalysis(data.data);
            }
        })
        .catch(error => {
            console.error('Error loading related analysis:', error);
        });
}

// 显示相关分析
function displayRelatedAnalysis(analyses) {
    const container = document.getElementById('related-analysis');
    
    if (analyses.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-muted text-center">暂无相关分析</p></div>';
        return;
    }
    
    const html = analyses.map(analysis => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${analysis.video?.title || '未知视频'}</h6>
                    <p class="card-text">
                        <small class="text-muted">${analysis.video?.author || '未知'}</small>
                    </p>
                    <p class="card-text">
                        <small class="text-muted">${new Date(analysis.created_at).toLocaleDateString()}</small>
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">${analysis.knowledge_entries_count || 0} 个知识点</span>
                        <a href="/analysis/${analysis.id}" class="btn btn-sm btn-outline-primary">
                            查看
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// 显示条目详情
function showEntryDetail(entryId) {
    fetch(`/api/v1/knowledge/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const entry = data.data;
                const content = `
                    <div class="row">
                        <div class="col-md-8">
                            <h4>${entry.title}</h4>
                            <div class="mb-3">
                                <span class="badge bg-{{ get_importance_color(entry.importance) }} me-2">
                                    重要性: ${entry.importance}
                                </span>
                                <span class="badge bg-secondary me-2">
                                    ${get_knowledge_type_label(entry.knowledge_type)}
                                </span>
                            </div>
                            <div class="mb-3">
                                ${entry.tags.map(tag => `<span class="badge bg-primary me-1">${tag}</span>`).join('')}
                            </div>
                            <div class="content-text">
                                ${entry.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">条目信息</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>创建时间:</strong> ${new Date(entry.created_at).toLocaleString()}</p>
                                    <p><strong>更新时间:</strong> ${new Date(entry.updated_at).toLocaleString()}</p>
                                    ${entry.analysis ? `
                                    <p><strong>来源视频:</strong> ${entry.analysis.video?.title || '未知'}</p>
                                    <p><strong>分析时间:</strong> ${new Date(entry.analysis.created_at).toLocaleString()}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('entry-detail-content').innerHTML = content;
                document.getElementById('entry-detail-title').textContent = entry.title;
                document.getElementById('view-entry-btn').href = `/knowledge/${entry.id}`;
                
                const modal = new bootstrap.Modal(document.getElementById('entry-detail-modal'));
                modal.show();
            } else {
                showToast('错误', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading entry detail:', error);
            showToast('错误', '加载条目详情失败', 'error');
        });
}

// 导出分析结果
function exportAnalysis() {
    const format = prompt('选择导出格式 (json, markdown, csv):', 'json');
    if (format && ['json', 'markdown', 'csv'].includes(format)) {
        window.open(`/api/v1/analysis/{{ analysis.id }}/export?format=${format}`, '_blank');
    }
}

// 重新分析
function reanalyze() {
    if (!confirm('确定要重新分析这个视频吗？这将覆盖现有的分析结果。')) {
        return;
    }
    
    const bvid = '{{ analysis.video.bvid }}';
    const language = '{{ analysis.subtitle.language }}';
    
    // 显示加载状态
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading-spinner me-2"></span>重新分析中...';
    button.disabled = true;
    
    fetch('/api/v1/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            bvid: bvid,
            language: language,
            force_reanalyze: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '重新分析已开始，请稍候查看结果', 'success');
            // 轮询检查分析状态
            pollAnalysisStatus(data.data.analysis.id);
        } else {
            showToast('错误', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error reanalyzing:', error);
        showToast('错误', '重新分析失败', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 轮询分析状态
function pollAnalysisStatus(analysisId) {
    const checkStatus = () => {
        fetch(`/api/v1/analysis/${analysisId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.data.status;
                    if (status === 'completed') {
                        showToast('成功', '分析已完成', 'success');
                        location.reload();
                    } else if (status === 'failed') {
                        showToast('错误', '分析失败', 'error');
                    } else {
                        // 继续轮询
                        setTimeout(checkStatus, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking analysis status:', error);
            });
    };
    
    checkStatus();
}

// 获取重要性颜色
function get_importance_color(importance) {
    const colors = {
        1: 'secondary',
        2: 'info',
        3: 'primary',
        4: 'warning',
        5: 'danger'
    };
    return colors[importance] || 'secondary';
}

// 获取知识类型标签
function get_knowledge_type_label(type) {
    const labels = {
        'concept': '概念',
        'definition': '定义',
        'example': '示例',
        'technique': '技巧'
    };
    return labels[type] || type;
}

// 显示提示消息
function showToast(title, message, type = 'info') {
    App.UI.showToast(title, message, type);
}
</script>
{% endblock %}